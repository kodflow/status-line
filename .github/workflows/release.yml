name: Rebuild All Releases

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "rebuild" to confirm deletion and rebuild of ALL releases'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  GO_VERSION: 'stable'
  BINARY_NAME: status-line

jobs:
  rebuild-releases:
    if: inputs.confirm == 'rebuild'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Get all tags
        id: tags
        run: |
          TAGS=$(git tag -l 'v*' | sort -V | tr '\n' ' ')
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Found tags: $TAGS"

      - name: Delete all existing releases
        run: |
          echo "Deleting all existing releases..."
          for tag in ${{ steps.tags.outputs.tags }}; do
            echo "Deleting release for $tag..."
            gh release delete "$tag" --yes 2>/dev/null || echo "No release for $tag"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebuild releases for each tag
        run: |
          for tag in ${{ steps.tags.outputs.tags }}; do
            echo "========================================"
            echo "Building release for $tag"
            echo "========================================"

            # Checkout the tag
            git checkout "$tag"

            # Clean and create dist directory
            rm -rf dist && mkdir -p dist

            # Build for all platforms
            for os in linux darwin windows; do
              for arch in amd64 arm64; do
                BINARY="${BINARY_NAME}-${os}-${arch}"
                if [ "$os" = "windows" ]; then
                  BINARY="${BINARY}.exe"
                fi
                echo "Building ${BINARY}..."
                GOOS=$os GOARCH=$arch CGO_ENABLED=0 go build \
                  -ldflags="-s -w -X main.version=${tag}" \
                  -o "dist/${BINARY}" \
                  ./cmd/statusline
                cd dist && sha256sum "${BINARY}" > "${BINARY}.sha256" && cd ..
              done
            done

            # Create the release
            echo "Creating release for $tag..."
            gh release create "$tag" \
              --title "Release $tag" \
              --generate-notes \
              dist/*

            echo "âœ… Release $tag created"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Releases Rebuilt" >> $GITHUB_STEP_SUMMARY
          for tag in ${{ steps.tags.outputs.tags }}; do
            echo "- $tag" >> $GITHUB_STEP_SUMMARY
          done
